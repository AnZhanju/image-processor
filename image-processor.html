<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线图片处理工具 - 多功能图片转换器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }

        .settings-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-group:last-child {
            margin-bottom: 0;
        }

        .settings-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .settings-title i {
            margin-right: 10px;
            color: #667eea;
        }

        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .format-option {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .format-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .format-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .quality-slider {
            width: 100%;
            margin: 10px 0;
        }

        .quality-value {
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        .size-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .size-input {
            display: flex;
            flex-direction: column;
        }

        .size-input label {
            margin-bottom: 5px;
            font-weight: 500;
        }

        .size-input input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .size-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .watermark-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .watermark-input {
            display: flex;
            flex-direction: column;
        }

        .watermark-input label {
            margin-bottom: 5px;
            font-weight: 500;
        }

        .watermark-input input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .watermark-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .image-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .image-item:hover {
            transform: translateY(-5px);
        }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-info {
            padding: 15px;
        }

        .image-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .image-size {
            color: #666;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-input {
            display: none;
        }

        .drag-hint {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #1976d2;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .size-controls,
            .watermark-controls {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🖼️ 在线图片处理工具</h1>
            <p>多功能图片转换器 - 无需上传，保护隐私</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <div class="tab active" data-tab="converter">
                    <i class="icon">🔄</i> 格式转换
                </div>
                <div class="tab" data-tab="compressor">
                    <i class="icon">📦</i> 图片压缩
                </div>
                <div class="tab" data-tab="watermark">
                    <i class="icon">💧</i> 添加水印
                </div>
            </div>

            <!-- 格式转换 -->
            <div class="tab-content active" id="converter">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">拖拽图片到此处或点击选择文件</div>
                    <div class="upload-hint">支持 JPG, PNG, WebP, GIF, SVG, BMP 等格式</div>
                    <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
                </div>

                <div class="settings-panel">
                    <div class="settings-group">
                        <div class="settings-title">
                            <i>🎨</i> 输出格式
                        </div>
                        <div class="format-options">
                            <div class="format-option selected" data-format="jpg">JPG</div>
                            <div class="format-option" data-format="png">PNG</div>
                            <div class="format-option" data-format="webp">WebP</div>
                            <div class="format-option" data-format="gif">GIF</div>
                            <div class="format-option" data-format="avif">AVIF</div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">
                            <i>⚙️</i> 图片质量
                        </div>
                        <input type="range" class="quality-slider" id="qualitySlider" min="1" max="100" value="80">
                        <div class="quality-value" id="qualityValue">80%</div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">
                            <i>📏</i> 尺寸调整
                        </div>
                        <div class="size-controls">
                            <div class="size-input">
                                <label>宽度 (像素)</label>
                                <input type="number" id="widthInput" placeholder="保持原尺寸">
                            </div>
                            <div class="size-input">
                                <label>高度 (像素)</label>
                                <input type="number" id="heightInput" placeholder="保持原尺寸">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="convertBtn" disabled>
                        <i>🔄</i> 开始转换
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <i>🗑️</i> 清空列表
                    </button>
                </div>

                <div class="image-preview" id="imagePreview"></div>
            </div>

            <!-- 图片压缩 -->
            <div class="tab-content" id="compressor">
                <div class="upload-area" id="uploadArea2">
                    <div class="upload-icon">📦</div>
                    <div class="upload-text">拖拽图片到此处进行压缩</div>
                    <div class="upload-hint">支持批量压缩，保持原格式</div>
                    <input type="file" id="fileInput2" class="file-input" multiple accept="image/*">
                </div>

                <div class="settings-panel">
                    <div class="settings-group">
                        <div class="settings-title">
                            <i>📊</i> 压缩设置
                        </div>
                        <div class="format-options">
                            <div class="format-option selected" data-compression="quality">质量压缩</div>
                            <div class="format-option" data-compression="size">尺寸压缩</div>
                            <div class="format-option" data-compression="both">双重压缩</div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">
                            <i>🎯</i> 目标大小 (KB)
                        </div>
                        <input type="number" id="targetSize" placeholder="500" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px;">
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="compressBtn" disabled>
                        <i>📦</i> 开始压缩
                    </button>
                    <button class="btn btn-secondary" id="clearBtn2">
                        <i>🗑️</i> 清空列表
                    </button>
                </div>

                <div class="image-preview" id="imagePreview2"></div>
            </div>

            <!-- 添加水印 -->
            <div class="tab-content" id="watermark">
                <div class="upload-area" id="uploadArea3">
                    <div class="upload-icon">💧</div>
                    <div class="upload-text">拖拽图片到此处添加水印</div>
                    <div class="upload-hint">支持文字水印和图片水印</div>
                    <input type="file" id="fileInput3" class="file-input" multiple accept="image/*">
                </div>

                <div class="settings-panel">
                    <div class="settings-group">
                        <div class="settings-title">
                            <i>💧</i> 水印设置
                        </div>
                        <div class="watermark-controls">
                            <div class="watermark-input">
                                <label>水印文字</label>
                                <input type="text" id="watermarkText" placeholder="输入水印文字">
                            </div>
                            <div class="watermark-input">
                                <label>水印图片</label>
                                <input type="file" id="watermarkImage" accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">
                            <i>📍</i> 水印位置
                        </div>
                        <div class="format-options">
                            <div class="format-option selected" data-position="top-left">左上</div>
                            <div class="format-option" data-position="top-right">右上</div>
                            <div class="format-option" data-position="bottom-left">左下</div>
                            <div class="format-option" data-position="bottom-right">右下</div>
                            <div class="format-option" data-position="center">居中</div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="watermarkBtn" disabled>
                        <i>💧</i> 添加水印
                    </button>
                    <button class="btn btn-secondary" id="clearBtn3">
                        <i>🗑️</i> 清空列表
                    </button>
                </div>

                <div class="image-preview" id="imagePreview3"></div>
            </div>
        </div>
    </div>

    <script>
        class ImageProcessor {
            constructor() {
                this.images = [];
                this.currentTab = 'converter';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupTabs();
                this.setupUploadAreas();
            }

            setupEventListeners() {
                // 质量滑块
                const qualitySlider = document.getElementById('qualitySlider');
                const qualityValue = document.getElementById('qualityValue');
                qualitySlider.addEventListener('input', (e) => {
                    qualityValue.textContent = e.target.value + '%';
                });

                // 格式选择
                document.querySelectorAll('.format-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const parent = e.target.closest('.settings-group');
                        parent.querySelectorAll('.format-option').forEach(opt => opt.classList.remove('selected'));
                        e.target.classList.add('selected');
                    });
                });

                // 按钮事件
                document.getElementById('convertBtn').addEventListener('click', () => this.convertImages());
                document.getElementById('compressBtn').addEventListener('click', () => this.compressImages());
                document.getElementById('watermarkBtn').addEventListener('click', () => this.addWatermarks());
                
                document.getElementById('clearBtn').addEventListener('click', () => this.clearImages('converter'));
                document.getElementById('clearBtn2').addEventListener('click', () => this.clearImages('compressor'));
                document.getElementById('clearBtn3').addEventListener('click', () => this.clearImages('watermark'));
            }

            setupTabs() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.target.dataset.tab;
                        this.switchTab(tabName);
                    });
                });
            }

            switchTab(tabName) {
                // 更新标签页状态
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // 更新内容区域
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');

                this.currentTab = tabName;
            }

            setupUploadAreas() {
                const uploadAreas = ['uploadArea', 'uploadArea2', 'uploadArea3'];
                const fileInputs = ['fileInput', 'fileInput2', 'fileInput3'];

                uploadAreas.forEach((areaId, index) => {
                    const area = document.getElementById(areaId);
                    const fileInput = document.getElementById(fileInputs[index]);

                    // 点击上传
                    area.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files, index));

                    // 拖拽上传
                    area.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        area.classList.add('dragover');
                    });

                    area.addEventListener('dragleave', () => {
                        area.classList.remove('dragover');
                    });

                    area.addEventListener('drop', (e) => {
                        e.preventDefault();
                        area.classList.remove('dragover');
                        this.handleFileSelect(e.dataTransfer.files, index);
                    });
                });
            }

            handleFileSelect(files, tabIndex) {
                const tabs = ['converter', 'compressor', 'watermark'];
                const currentTab = tabs[tabIndex];
                
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        this.addImage(file, currentTab);
                    }
                });

                this.updateButtons(tabIndex);
            }

            addImage(file, tab) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        url: e.target.result,
                        name: file.name,
                        size: file.size,
                        tab: tab
                    };

                    this.images.push(imageData);
                    this.displayImage(imageData);
                };
                reader.readAsDataURL(file);
            }

            displayImage(imageData) {
                const previewId = `imagePreview${imageData.tab === 'converter' ? '' : imageData.tab === 'compressor' ? '2' : '3'}`;
                const preview = document.getElementById(previewId);

                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${imageData.url}" alt="${imageData.name}">
                    <div class="image-info">
                        <div class="image-name">${imageData.name}</div>
                        <div class="image-size">${this.formatFileSize(imageData.size)}</div>
                    </div>
                `;

                preview.appendChild(imageItem);
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            updateButtons(tabIndex) {
                const buttons = ['convertBtn', 'compressBtn', 'watermarkBtn'];
                const button = document.getElementById(buttons[tabIndex]);
                const images = this.images.filter(img => {
                    const tabs = ['converter', 'compressor', 'watermark'];
                    return img.tab === tabs[tabIndex];
                });
                
                button.disabled = images.length === 0;
            }

            clearImages(tab) {
                const previewId = `imagePreview${tab === 'converter' ? '' : tab === 'compressor' ? '2' : '3'}`;
                const preview = document.getElementById(previewId);
                preview.innerHTML = '';
                
                this.images = this.images.filter(img => img.tab !== tab);
                this.updateButtons(['converter', 'compressor', 'watermark'].indexOf(tab));
            }

            async convertImages() {
                const images = this.images.filter(img => img.tab === 'converter');
                if (images.length === 0) return;

                const format = document.querySelector('#converter .format-option.selected').dataset.format;
                const quality = document.getElementById('qualitySlider').value / 100;
                const width = document.getElementById('widthInput').value;
                const height = document.getElementById('heightInput').value;

                this.showLoading('converter');

                for (let i = 0; i < images.length; i++) {
                    const image = images[i];
                    await this.processImage(image, {
                        type: 'convert',
                        format: format,
                        quality: quality,
                        width: width || null,
                        height: height || null
                    });
                }

                this.hideLoading('converter');
                this.downloadResults(images, format);
            }

            async compressImages() {
                const images = this.images.filter(img => img.tab === 'compressor');
                if (images.length === 0) return;

                const compression = document.querySelector('#compressor .format-option.selected').dataset.compression;
                const targetSize = document.getElementById('targetSize').value;

                this.showLoading('compressor');

                for (let i = 0; i < images.length; i++) {
                    const image = images[i];
                    await this.processImage(image, {
                        type: 'compress',
                        compression: compression,
                        targetSize: targetSize
                    });
                }

                this.hideLoading('compressor');
                this.downloadResults(images, 'compressed');
            }

            async addWatermarks() {
                const images = this.images.filter(img => img.tab === 'watermark');
                if (images.length === 0) return;

                const text = document.getElementById('watermarkText').value;
                const position = document.querySelector('#watermark .format-option.selected').dataset.position;
                const watermarkFile = document.getElementById('watermarkImage').files[0];

                this.showLoading('watermark');

                for (let i = 0; i < images.length; i++) {
                    const image = images[i];
                    await this.processImage(image, {
                        type: 'watermark',
                        text: text,
                        position: position,
                        watermarkFile: watermarkFile
                    });
                }

                this.hideLoading('watermark');
                this.downloadResults(images, 'watermarked');
            }

            async processImage(imageData, options) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = () => {
                        // 设置画布尺寸
                        let targetWidth = img.width;
                        let targetHeight = img.height;

                        if (options.width && options.height) {
                            targetWidth = parseInt(options.width);
                            targetHeight = parseInt(options.height);
                        } else if (options.width) {
                            const ratio = img.height / img.width;
                            targetWidth = parseInt(options.width);
                            targetHeight = targetWidth * ratio;
                        } else if (options.height) {
                            const ratio = img.width / img.height;
                            targetHeight = parseInt(options.height);
                            targetWidth = targetHeight * ratio;
                        }

                        canvas.width = targetWidth;
                        canvas.height = targetHeight;

                        // 绘制图片
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                        // 添加水印
                        if (options.type === 'watermark' && options.text) {
                            this.addTextWatermark(ctx, options.text, options.position, targetWidth, targetHeight);
                        }

                        // 转换为指定格式
                        let mimeType = 'image/jpeg';
                        if (options.format === 'png') mimeType = 'image/png';
                        else if (options.format === 'webp') mimeType = 'image/webp';
                        else if (options.format === 'gif') mimeType = 'image/gif';

                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            imageData.processedUrl = url;
                            imageData.processedBlob = blob;
                            resolve();
                        }, mimeType, options.quality || 0.8);
                    };

                    img.src = imageData.url;
                });
            }

            addTextWatermark(ctx, text, position, width, height) {
                ctx.font = '24px Arial';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.lineWidth = 2;

                const textWidth = ctx.measureText(text).width;
                let x, y;

                switch (position) {
                    case 'top-left':
                        x = 20;
                        y = 30;
                        break;
                    case 'top-right':
                        x = width - textWidth - 20;
                        y = 30;
                        break;
                    case 'bottom-left':
                        x = 20;
                        y = height - 20;
                        break;
                    case 'bottom-right':
                        x = width - textWidth - 20;
                        y = height - 20;
                        break;
                    case 'center':
                        x = (width - textWidth) / 2;
                        y = height / 2;
                        break;
                }

                ctx.strokeText(text, x, y);
                ctx.fillText(text, x, y);
            }

            downloadResults(images, suffix) {
                images.forEach((image, index) => {
                    if (image.processedBlob) {
                        const link = document.createElement('a');
                        link.href = image.processedUrl;
                        link.download = `${image.name.replace(/\.[^/.]+$/, '')}_${suffix}.${this.getFileExtension(image.processedBlob.type)}`;
                        link.click();
                    }
                });
            }

            getFileExtension(mimeType) {
                const extensions = {
                    'image/jpeg': 'jpg',
                    'image/png': 'png',
                    'image/webp': 'webp',
                    'image/gif': 'gif'
                };
                return extensions[mimeType] || 'jpg';
            }

            showLoading(tab) {
                const tabContent = document.getElementById(tab);
                const loading = document.createElement('div');
                loading.className = 'loading';
                loading.innerHTML = `
                    <div class="spinner"></div>
                    <div>处理中...</div>
                `;
                loading.id = 'loading';
                tabContent.appendChild(loading);
            }

            hideLoading(tab) {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.remove();
                }
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new ImageProcessor();
        });
    </script>
</body>
</html> 